<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Meal Macro Analyzer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Tailwind Configuration
        tailwind.config = {
            darkMode: 'class', // Enable dark mode using 'dark' class on parent element (body)
            theme: {
                extend: {
                    colors: {
                        'primary-green': '#00B894',
                        'accent-blue': '#4c7cff', // Custom blue for calories/card contrast
                        'dark-bg': '#1e293b',
                        'card-bg-dark': '#1f2937', // Gray 800
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }

        // --- Firebase Initialization and Auth ---
        let db;
        let auth;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        if (firebaseConfig) {
            setLogLevel('debug'); // Enable Firestore logging for debugging
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            // Simple sign-in
            onAuthStateChanged(auth, async (user) => {
                if (!user) {
                    try {
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (error) {
                        console.error("Firebase Auth Error:", error);
                    }
                }
            });
        } else {
            console.error("Firebase config is missing. Authentication and database features are disabled.");
        }
        // --- End Firebase Init ---

        // Global variables
        let selectedFileBase64 = null;
        let selectedFileMimeType = null; 
        const API_KEY = ""; // Key is handled by the Canvas environment
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${API_KEY}`;
        const MAX_RETRIES = 5;

        // --- Theme Toggle Logic ---
        let currentTheme = localStorage.getItem('theme') || 'light';

        function setTheme(theme) {
            currentTheme = theme;
            localStorage.setItem('theme', theme);
            const body = document.body;
            
            if (theme === 'dark') {
                body.classList.add('dark');
                body.style.backgroundColor = '#1e293b'; 
            } else {
                body.classList.remove('dark');
                body.style.backgroundColor = '#f1f5f9';
            }

            // Update the icon to reflect the current theme
            const themeIcon = document.getElementById('theme-icon');
            if (themeIcon) {
                if (theme === 'dark') {
                    // Sun icon (Light mode)
                    themeIcon.innerHTML = `<svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 10a4 4 0 11-8 0 4 4 0 018 0zm-.87-5.13a1 1 0 010 1.41l-.71.71a1 1 0 01-1.41-1.41l.71-.71a1 1 0 011.41 0zM5 12a1 1 0 100-2H4a1 1 0 100 2h1zm7.71 4.29a1 1 0 01-1.41 0l-.71-.71a1 1 0 011.41-1.41l.71.71a1 1 0 010 1.41zM2 12a1 1 0 110-2h1a1 1 0 110 2H2zm10.71 4.29a1 1 0 01-1.41 0l-.71-.71a1 1 0 011.41-1.41l.71.71a1 1 0 010 1.41zM16 12a1 1 0 110-2h1a1 1 0 110 2h-1zM5.71 4.29a1 1 0 011.41 0l.71.71a1 1 0 01-1.41 1.41l-.71-.71a1 1 0 010-1.41zM10 17a1 1 0 110 2 1 1 0 010-2z" fill-rule="evenodd" clip-rule="evenodd"></path></svg>`;
                } else {
                    // Moon icon (Dark mode)
                    themeIcon.innerHTML = `<svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path></svg>`;
                }
            }
        }

        window.toggleTheme = () => {
            setTheme(currentTheme === 'light' ? 'dark' : 'light');
        };

        // Apply initial theme on load
        window.addEventListener('DOMContentLoaded', () => {
            setTheme(currentTheme);
        });
        // --- End Theme Toggle Logic ---

        // --- Utility Functions ---

        /**
         * Converts a File object to a base64 string for the API.
         */
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result.split(',')[1]); // Only need the base64 part
                reader.onerror = error => reject(error);
            });
        }

        /**
         * Handles exponential backoff for API retries.
         */
        function delay(attempt) {
            const ms = Math.pow(2, attempt) * 1000 + Math.random() * 1000;
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        /**
         * Shows a message box in the UI.
         */
        function showMessage(message, isError = false) {
            const messageBox = document.getElementById('message-box');
            messageBox.textContent = message;
            messageBox.className = `p-3 mt-4 rounded-lg text-sm text-center ${isError ? 'bg-red-600 text-white' : 'bg-primary-green text-white'}`;
            messageBox.classList.remove('hidden');
        }

        function hideMessage() {
            document.getElementById('message-box').classList.add('hidden');
        }

        // --- UI Handlers ---

        /**
         * Handles the file input change event.
         * Displays the image and prepares the base64 data.
         */
        window.handleFileSelect = async (event) => {
            hideMessage();
            const file = event.target.files[0];
            const preview = document.getElementById('image-preview');
            const analyzeButton = document.getElementById('analyze-button');

            if (file) {
                if (!file.type.startsWith('image/')) {
                    showMessage("Please select an image file (JPEG, PNG, etc.).", true);
                    analyzeButton.disabled = true;
                    preview.src = "";
                    preview.classList.add('hidden');
                    return;
                }

                try {
                    // Preview the image
                    preview.src = URL.createObjectURL(file);
                    preview.classList.remove('hidden');
                    
                    // Store MIME type
                    selectedFileMimeType = file.type;

                    // Convert to base64 for API
                    selectedFileBase64 = await fileToBase64(file);
                    analyzeButton.disabled = false;
                    document.getElementById('results-container').classList.add('hidden'); // Hide old results

                } catch (error) {
                    console.error("Error processing file:", error);
                    showMessage("Could not process image file.", true);
                    analyzeButton.disabled = true;
                }
            } else {
                preview.src = "";
                preview.classList.add('hidden');
                analyzeButton.disabled = true;
                selectedFileBase64 = null;
                selectedFileMimeType = null;
            }
        };

        /**
         * Triggers the AI analysis of the meal photo.
         */
        window.analyzeMeal = async () => {
            if (!selectedFileBase64 || !selectedFileMimeType) {
                showMessage("Please select a meal photo first.", true);
                return;
            }

            const analyzeButton = document.getElementById('analyze-button');
            const spinner = document.getElementById('loading-spinner');
            const resultsContainer = document.getElementById('results-container');
            const refinementText = document.getElementById('refinement-input').value.trim();

            analyzeButton.disabled = true;
            spinner.classList.remove('hidden');
            resultsContainer.classList.add('hidden');
            hideMessage();
            
            // Define the instruction and structured output schema
            let prompt = `Analyze this image of a meal. Identify the main ingredients and estimate the serving size. Based on your analysis, provide the total estimated Calories, grams of Protein, grams of Carbohydrates (Carbs), and grams of Fat for the entire visible meal. Provide a brief, encouraging "Daily Insight" (around 10-15 words).`;

            if (refinementText) {
                // If refinement text is provided, instruct the model to use it.
                prompt = `Analyze this image of a meal. For the analysis, use the following additional information: "${refinementText}". Identify the main ingredients and estimate the serving size. Based on your analysis, provide the total estimated Calories, grams of Protein, grams of Carbohydrates (Carbs), and grams of Fat for the entire visible meal. Provide a brief, encouraging "Daily Insight" (around 10-15 words). The analysis should be based on the image, refined by the provided text.`;
            } else {
                // Default prompt if no refinement text is provided.
                prompt += ` The analysis should be based solely on the image.`;
            }

            const payload = {
                contents: [{
                    role: "user",
                    parts: [
                        { text: prompt },
                        {
                            inlineData: {
                                mimeType: selectedFileMimeType, // Use actual MIME type
                                data: selectedFileBase64
                            }
                        }
                    ]
                }],
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            "calories": { "type": "NUMBER", "description": "Total estimated Calories (kcal) for the meal." },
                            "protein_grams": { "type": "NUMBER", "description": "Total estimated Protein in grams." },
                            "carbs_grams": { "type": "NUMBER", "description": "Total estimated Carbohydrates in grams." },
                            "fat_grams": { "type": "NUMBER", "description": "Total estimated Fat in grams." },
                            "insight": { "type": "STRING", "description": "A brief, encouraging daily insight/tip related to the meal." },
                            "identified_items": { "type": "STRING", "description": "A list of identified food items and estimated serving sizes, e.g., 'Grilled Chicken Breast (4oz), Quinoa (1 cup), Asparagus (5 spears), 4 Cherry Tomatoes, 1/4 Avocado.'" }
                        },
                        required: ["calories", "protein_grams", "carbs_grams", "fat_grams", "insight", "identified_items"]
                    }
                }
            };

            for (let attempt = 0; attempt < MAX_RETRIES; attempt++) {
                try {
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                         if (response.status === 429 && attempt < MAX_RETRIES - 1) {
                            await delay(attempt);
                            continue;
                        }
                        const errorBody = await response.json();
                        throw new Error(`API Request failed with status ${response.status}: ${JSON.stringify(errorBody)}`);
                    }

                    const result = await response.json();
                    const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;

                    if (!jsonText) {
                        throw new Error("Received empty or malformed response from AI model.");
                    }

                    const macroData = JSON.parse(jsonText);
                    displayResults(macroData);
                    break; // Success, exit retry loop

                } catch (error) {
                    console.error(`Attempt ${attempt + 1} failed:`, error);
                    if (attempt === MAX_RETRIES - 1) {
                        showMessage("AI analysis failed after multiple retries. Please try a different photo or check the console for details.", true);
                    } else {
                        await delay(attempt);
                    }
                }
            }

            analyzeButton.disabled = false;
            spinner.classList.add('hidden');
        };

        /**
         * Renders the macro results into the UI.
         */
        function displayResults(data) {
            const resultsContainer = document.getElementById('results-container');
            const identifiedItems = document.getElementById('identified-items');
            const dailyInsight = document.getElementById('daily-insight');

            // Set the main macro values
            document.getElementById('cal-result').textContent = `${data.calories.toFixed(0)} kcal`;
            document.getElementById('protein-result').textContent = `${data.protein_grams.toFixed(1)}g`;
            document.getElementById('carbs-result').textContent = `${data.carbs_grams.toFixed(1)}g`;
            document.getElementById('fat-result').textContent = `${data.fat_grams.toFixed(1)}g`;

            // Set the descriptive text
            dailyInsight.textContent = data.insight;
            identifiedItems.textContent = data.identified_items;

            // Simple calculation for macro percentages 
            const totalMacros = data.protein_grams * 4 + data.carbs_grams * 4 + data.fat_grams * 9;

            const proteinPercent = totalMacros > 0 ? (data.protein_grams * 4 / totalMacros) : 0;
            const carbsPercent = totalMacros > 0 ? (data.carbs_grams * 4 / totalMacros) : 0;
            const fatPercent = totalMacros > 0 ? (data.fat_grams * 9 / totalMacros) : 0;

            document.getElementById('protein-percent').textContent = `${(proteinPercent * 100).toFixed(0)}%`;
            document.getElementById('carbs-percent').textContent = `${(carbsPercent * 100).toFixed(0)}%`;
            document.getElementById('fat-percent').textContent = `${(fatPercent * 100).toFixed(0)}%`;

            document.getElementById('protein-bar').style.width = `${Math.min(100, proteinPercent * 100)}%`;
            document.getElementById('carbs-bar').style.width = `${Math.min(100, carbsPercent * 100)}%`;
            document.getElementById('fat-bar').style.width = `${Math.min(100, fatPercent * 100)}%`;

            resultsContainer.classList.remove('hidden');
        }

    </script>
    <style>
        /* Custom CSS for Inter font, modern look, and macro bars */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
        }
        .dark {
            color-scheme: dark;
        }
        .macro-bar-container {
            height: 6px; /* Slightly thinner bar */
            border-radius: 3px;
            background-color: #e5e7eb; /* Gray 200 */
            overflow: hidden;
            width: 100%;
        }
        .dark .macro-bar-container {
            background-color: #374151; /* Gray 700 */
        }
        .macro-bar {
            height: 100%;
            transition: width 0.5s ease-out;
        }
    </style>
</head>
<body class="min-h-screen">

    <!-- Overall Content Wrapper to control max width and centering -->
    <div class="max-w-xl mx-auto p-4 sm:p-8">

        <!-- Header and Theme Toggle -->
        <header class="mb-6 flex justify-between items-center bg-white dark:bg-gray-800 p-4 rounded-xl shadow-md dark:shadow-lg transition-colors">
            <h1 class="text-xl font-bold text-gray-800 dark:text-gray-100">Macro Photo Analyzer</h1>
            <button id="theme-toggle" onclick="toggleTheme()" class="p-2 text-gray-600 dark:text-gray-300 hover:text-primary-green dark:hover:text-primary-green transition duration-300 rounded-full">
                <span id="theme-icon"></span>
            </button>
        </header>

        <!-- Main Content Card (Input Area) -->
        <div class="bg-white dark:bg-gray-900 p-6 rounded-xl shadow-2xl dark:shadow-none dark:border dark:border-gray-700 transition-colors">
            <h2 class="text-2xl font-semibold mb-6 text-gray-700 dark:text-gray-200">Scan Your Meal</h2>

            <!-- Image Upload and Preview Area -->
            <div class="mb-6 border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-xl p-6 text-center hover:border-primary-green transition duration-300">
                <input type="file" accept="image/*" id="file-input" class="hidden" onchange="handleFileSelect(event)">
                <label for="file-input" class="cursor-pointer flex flex-col items-center justify-center">
                    <svg class="w-10 h-10 text-gray-400 dark:text-gray-500 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.218A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.218A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                    <span class="text-gray-600 dark:text-gray-300 font-medium">Click to upload a meal photo</span>
                    <span class="text-xs text-gray-400 dark:text-gray-500">(JPEG or PNG)</span>
                </label>
                <img id="image-preview" src="" alt="Meal Preview" class="mt-4 max-h-64 w-full object-contain rounded-lg shadow-md hidden mx-auto">
            </div>

            <!-- Refinement Input Area - NEW SECTION -->
            <div class="mb-6">
                <label for="refinement-input" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                    Optional: Fine-tune analysis (e.g., weights, specific ingredients)
                </label>
                <textarea id="refinement-input" rows="3" 
                          placeholder="Example: The meat is 150g of lean ground turkey. The rice is 1 cup cooked. Everything was cooked with 1 tablespoon of olive oil."
                          class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-800 dark:text-gray-100 focus:ring-primary-green focus:border-primary-green transition duration-200 resize-none"></textarea>
            </div>

            <!-- Action Button -->
            <button id="analyze-button" onclick="analyzeMeal()" disabled
                    class="w-full py-3 bg-primary-green text-white font-bold rounded-lg shadow-lg hover:bg-green-600 transition duration-300 disabled:bg-gray-400 flex items-center justify-center">
                <span id="loading-spinner" class="hidden mr-2">
                    <svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                </span>
                <span>Analyze Meal Macros</span>
            </button>
        </div>

        <!-- Message Box -->
        <div id="message-box" class="hidden"></div>

        <!-- Results Container (Initially Hidden) -->
        <div id="results-container" class="mt-8 hidden">
            <h3 class="text-2xl font-bold text-gray-800 dark:text-gray-100 mb-6">Analysis Results</h3>

            <!-- 1. Insight & Identified Items Summary Card -->
            <div class="bg-white dark:bg-gray-900 p-6 rounded-xl shadow-lg dark:shadow-none dark:border dark:border-gray-700 mb-6">
                <div class="border-b border-gray-100 dark:border-gray-800 pb-4 mb-4">
                    <p class="text-lg font-semibold text-primary-green mb-1 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path></svg>
                        Daily Insight
                    </p>
                    <p id="daily-insight" class="text-gray-700 dark:text-gray-300 italic"></p>
                </div>
                
                <p class="text-md font-semibold text-gray-700 dark:text-gray-300 mb-2">Identified Components:</p>
                <p id="identified-items" class="text-sm text-gray-500 dark:text-gray-400 leading-relaxed"></p>
            </div>

            <!-- 2. Macro Cards Grid -->
            <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">

                <!-- Calories Card -->
                <div class="p-4 bg-white dark:bg-card-bg-dark rounded-xl shadow-md dark:shadow-none dark:border dark:border-gray-700 flex flex-col justify-between transition-colors">
                    <p class="text-sm font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider mb-2">Calories</p>
                    <p id="cal-result" class="text-3xl font-extrabold text-accent-blue dark:text-blue-400"></p>
                </div>

                <!-- Protein Card -->
                <div class="p-4 bg-white dark:bg-card-bg-dark rounded-xl shadow-md dark:shadow-none dark:border dark:border-gray-700 flex flex-col justify-between transition-colors">
                    <p class="text-sm font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider mb-2">Protein</p>
                    <p id="protein-result" class="text-3xl font-extrabold text-red-600 dark:text-red-400"></p>
                    <div class="mt-3">
                        <div id="protein-bar-container" class="macro-bar-container">
                            <div id="protein-bar" class="macro-bar bg-red-600" style="width: 0%;"></div>
                        </div>
                        <p id="protein-percent" class="text-xs font-semibold text-red-600 dark:text-red-400 mt-1 text-right"></p>
                    </div>
                </div>

                <!-- Carbs Card -->
                <div class="p-4 bg-white dark:bg-card-bg-dark rounded-xl shadow-md dark:shadow-none dark:border dark:border-gray-700 flex flex-col justify-between transition-colors">
                    <p class="text-sm font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider mb-2">Carbs</p>
                    <p id="carbs-result" class="text-3xl font-extrabold text-yellow-600 dark:text-yellow-400"></p>
                    <div class="mt-3">
                        <div id="carbs-bar-container" class="macro-bar-container">
                            <div id="carbs-bar" class="macro-bar bg-yellow-600" style="width: 0%;"></div>
                        </div>
                        <p id="carbs-percent" class="text-xs font-semibold text-yellow-600 dark:text-yellow-400 mt-1 text-right"></p>
                    </div>
                </div>

                <!-- Fat Card -->
                <div class="p-4 bg-white dark:bg-card-bg-dark rounded-xl shadow-md dark:shadow-none dark:border dark:border-gray-700 flex flex-col justify-between transition-colors">
                    <p class="text-sm font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider mb-2">Fat</p>
                    <p id="fat-result" class="text-3xl font-extrabold text-purple-600 dark:text-purple-400"></p>
                    <div class="mt-3">
                        <div id="fat-bar-container" class="macro-bar-container">
                            <div id="fat-bar" class="macro-bar bg-purple-600" style="width: 0%;"></div>
                        </div>
                        <p id="fat-percent" class="text-xs font-semibold text-purple-600 dark:text-purple-400 mt-1 text-right"></p>
                    </div>
                </div>

            </div>
        </div>

    </div>

</body>
</html>
